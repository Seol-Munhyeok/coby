version: 0.2

env:
  secret-manager:
    DB_USERNAME: "coby-app/db-credentials:DB_USERNAME"
    DB_PASSWORD: "coby-app/db-credentials:DB_PASSWORD"
    GOOGLE_CLIENT_ID: "coby-app/db-credentials:GOOGLE_CLIENT_ID"
    GOOGLE_CLIENT_SECRET: "coby-app/db-credentials:GOOGLE_CLIENT_SECRET"
    KAKAO_CLIENT_ID: "coby-app/db-credentials:KAKAO_CLIENT_ID"

phases:
  install:
    runtime-versions:
      nodejs: 20
      java: corretto17

  pre_build:
    commands:
      - echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜"
      - cd frontend
      - npm install
      - cd ..

  build:
    commands:
      - echo "ğŸ› ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ"
      - cd frontend
      - npm run build
      - cd ..

      - echo "ğŸ› ï¸ ë°±ì—”ë“œ Gradle ë¹Œë“œ"
      - cd backend
      - chmod +x ./gradlew
      - ./gradlew build -x test
      - cd ..

  post_build:
    commands:
      - echo "ğŸ“¦ ë°°í¬ ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„"

      - mkdir -p build_output/scripts
      - mkdir -p build_output/backend
      - mkdir -p build_output/frontend

      - cp scripts/*.sh build_output/scripts/
      - |
        cat <<EOF > build_output/scripts/env.sh
        export DB_USERNAME=${DB_USERNAME}
        export DB_PASSWORD=${DB_PASSWORD}
        export GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
        export GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
        export KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
        EOF

      - chmod +x build_output/scripts/*.sh

      - cp -r frontend/build build_output/frontend
      - mv backend/build/libs/*.jar build_output/backend || echo "âš ï¸ ë°±ì—”ë“œ JAR ë³µì‚¬ ì‹¤íŒ¨"

artifacts:
  base-directory: build_output
  files:
    - '**/*'
